<html>

<head>
    <!---Imports d3 and topojson --->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <style>
        svg#calisvg {
            fill: None;
        }

        svg#caliMinisvg {
            fill: None;
        }

        svg#nysvg {
            fill: None;
        }

        svg#nyMinisvg {
            fill: None;
        }
    </style>
</head>

<body>
    <svg id="calisvg" height="350" width="350"></svg>
    <svg id="caliMinisvg" height="350" width="350" style="border:2px solid rgb(211, 210, 210)"></svg>
    <svg id="nysvg" height="350" width="350"></svg>
    <svg id="nyMinisvg" height="350" width="350" style="border:2px solid rgb(211, 210, 210)"></svg>
    <script>
        const calisvg = d3.select("svg#calisvg");
        const nysvg = d3.select("svg#nysvg");

        const caliminisvg = d3.select("svg#caliMinisvg")
        const nyminisvg = d3.select("svg#nyMinisvg")

        // constants shared across all maps
        width = calisvg.attr("width");
        height = calisvg.attr("height");
        const margin = { top: 10, right: 10, bottom: 10, left: 10 };
        const mapWidth = width - margin.left - margin.right;
        const mapHeight = height - margin.top - margin.bottom;

        miniWidth = caliminisvg.attr("width");
        miniHeight = caliminisvg.attr("height");
        const miniMapWidth = miniWidth - margin.left - margin.right;
        const miniMapHeight = miniHeight - margin.left - margin.right;

        const requestData = async function () {
            // start california map
            const calijson = await d3.json("./cali.topojson")
            var caliFeat = topojson.feature(calijson, calijson.objects.cali)
            var caliMesh = topojson.mesh(calijson, calijson.objects.cali)

            var caliProjection = d3.geoMercator().fitSize([mapWidth, mapHeight], caliFeat);
            var calipath = d3.geoPath().projection(caliProjection);

            // console.log(caliFeat)
            let calimap = calisvg.append("g").attr("id", "californiaMap");

            let caliPaths = calimap.selectAll("path.neighbors").data(caliFeat.features)
                .join("path")
                .attr("class", "neighbors")
                .attr("d", calipath)
                .style("fill", "lightgray");

            let caliPath = calimap.append("path").datum(caliMesh)
                .attr("class", "outline")
                .attr("d", calipath)
                .style("stroke", "white")
                .attr("class", "neighbor-outline")
                .style("stroke-width", 1);

            // end california map


            // start cali mini map
            let caliMiniMap = caliminisvg.append("g").attr("id", "caliMiniMap");

            let caliMiniPaths = caliMiniMap.selectAll("path.neighbors").data(caliFeat.features)
                .join("path")
                .attr("class", "neighbors")
                .attr("d", calipath)
                .style("fill", "lightgray");

            let caliMiniPath = caliMiniMap.append("path").datum(caliMesh)
                .attr("class", "outline")
                .attr("d", calipath)
                .style("stroke", "white")
                .attr("class", "neighbor-outline")
                .style("stroke-width", 1);
            // end cali mini map

            // start new york map
            const nyjson = await d3.json("./newyork.topojson")
            var nyFeat = topojson.feature(nyjson, nyjson.objects.newyork)
            var nyMesh = topojson.mesh(nyjson, nyjson.objects.newyork)

            var nyProjection = d3.geoMercator().fitSize([mapWidth, mapHeight], nyFeat);
            var nypath = d3.geoPath().projection(nyProjection);

            let nymap = nysvg.append("g").attr("id", "newyorkMap");

            let nyPaths = nymap.selectAll("path.neighbors").data(nyFeat.features)
                .join("path")
                .attr("class", "neighbors")
                .attr("d", nypath)
                .style("fill", "lightgray");

            let nyPath = nymap.append("path").datum(nyMesh)
                .attr("class", "outline")
                .attr("d", nypath)
                .style("stroke", "white")
                .attr("class", "neighbor-outline")
                .style("stroke-width", 1);
            // end new york map

            // start new york mini map
            let nyMiniMap = nyminisvg.append("g").attr("id", "nyMiniMap");

            let nyMiniPaths = nyMiniMap.selectAll("path.neighbors").data(nyFeat.features)
                .join("path")
                .attr("class", "neighbors")
                .attr("d", nypath)
                .style("fill", "lightgray");

            let nyMiniPath = nyMiniMap.append("path").datum(nyMesh)
                .attr("class", "outline")
                .attr("d", nypath)
                .style("stroke", "white")
                .attr("class", "neighbor-outline")
                .style("stroke-width", 1);
            // end new york mini map

            d3.csv('./startup_filtered.csv', d3.autoType)
                .then((data) => {
                    // data that is in california
                    var caliPoints = []
                    // data that is in new york
                    var nyPoints = []

                    data.forEach(function (point) {
                        if (point.state_code == "CA") {
                            caliPoints.push(point);
                        }
                        else if (point.state_code == "NY") {
                            nyPoints.push(point);
                        }
                    });
                    // console.log(caliPoints)

                    var caliCircles = calimap.selectAll("circle").data(caliPoints)
                        .join("circle")
                        .attr("cx", d => caliProjection([d['longitude'], d['latitude']])[0])
                        .attr("cy", d => caliProjection([d['longitude'], d['latitude']])[1])
                        .attr("r", 0.5)
                        .attr("opacity", 0.4)
                        .attr("fill", "blue")

                    var caliMiniCircles = caliMiniMap.selectAll("circle").data(caliPoints)
                        .join("circle")
                        .attr("cx", d => caliProjection([d['longitude'], d['latitude']])[0])
                        .attr("cy", d => caliProjection([d['longitude'], d['latitude']])[1])
                        .attr("r", 0.3)
                        .attr("opacity", 0.3)
                        .attr("fill", "blue")

                    // cali zoom
                    var caliZoom = d3.zoom()
                        .scaleExtent([1, 70]) // Define the minimum and maximum zoom levels
                        .on("zoom", caliZoomFunc);
                    caliminisvg.call(caliZoom);
                    // caliminisvg.call(zoom.transform, d3.zoomIdentity);
                    caliminisvg.call(caliZoom.transform, d3.zoomIdentity
                        .translate(-(15 * 75), -(15 * 150))
                        .scale(15));

                    function caliZoomFunc({ transform }) {
                        caliMiniMap.attr("transform", transform.toString());
                        caliMiniMap.select(".neighbor-outline")
                            .style("stroke-width", 3 / transform.k);
                        caliMiniMap.select(".neighbors")
                            .style("stroke-width", 1 / transform.k);
                        caliMiniCircles.attr("r", 4 / transform.k);
                    }


                    var nyCircles = nymap.selectAll("circle").data(nyPoints)
                        .join("circle")
                        .attr("cx", d => nyProjection([d['longitude'], d['latitude']])[0])
                        .attr("cy", d => nyProjection([d['longitude'], d['latitude']])[1])
                        .attr("r", 1)
                        .attr("opacity", 1)
                        .attr("fill", "blue")

                    var nyMiniCircles = nyMiniMap.selectAll("circle").data(nyPoints)
                        .join("circle")
                        .attr("cx", d => nyProjection([d['longitude'], d['latitude']])[0])
                        .attr("cy", d => nyProjection([d['longitude'], d['latitude']])[1])
                        .attr("r", 0.3)
                        .attr("opacity", 0.3)
                        .attr("fill", "blue")

                    // ny zoom
                    var nyZoom = d3.zoom()
                        .scaleExtent([1, 70]) // Define the minimum and maximum zoom levels
                        .on("zoom", nyZoomFunc);
                    nyminisvg.call(nyZoom);
                    // caliminisvg.call(zoom.transform, d3.zoomIdentity);
                    nyminisvg.call(nyZoom.transform, d3.zoomIdentity
                        .translate(-(25 * 232), -(25 * 272))
                        .scale(25));

                    function nyZoomFunc({ transform }) {
                        nyMiniMap.attr("transform", transform.toString());
                        nyMiniMap.select(".neighbor-outline")
                            .style("stroke-width", 3 / transform.k);
                        nyMiniMap.select(".neighbors")
                            .style("stroke-width", 1 / transform.k);
                        nyMiniCircles.attr("r", 4 / transform.k);
                    }

                })





        }
        requestData();

    </script>
</body>